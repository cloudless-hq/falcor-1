{"version":3,"sources":["../../src/components/container.js"],"names":["container","contextTypes","falcor","object","version","number","dispatch","func","FalcorContainer","props","context","data","constructor","fragment","Component","mergeFragmentAndProps","mapFragment","mapDispatch","state","propsStream","propsAction","map","rest","$__path","length","deref","switchMap","d2","error","getVersion","nextProps","nextState","nextContext","thisVersion","thisJSON","restProps","nextVersion","nextJSON","restNextProps","$__hash","next","propsSubscription","subscribe","setState","unsubscribe","loading","mappedFragment","mappedDispatch","$__key","$__refPath","$__version","$__hash__$","$__keysPath","$__keyDepth","$__toReference","allMergedProps","childContextTypes","defaultMapFragmentToProps","defaultMapDispatchToProps","defaultMergeProps","stateProps","dispatchProps","parentProps","getFragment","actionCreators","BaseComponent","displayName"],"mappings":"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","file":"container.js","sourcesContent":["import { Subject } from 'rxjs';\nimport React, { PropTypes, Children } from 'react';\nimport hoistStatics from 'recompose/hoistStatics';\nimport shallowEqual from 'recompose/shallowEqual';\nimport mapToFalcorJSON from '../utils/mapToFalcorJSON';\nimport wrapDisplayName from 'recompose/wrapDisplayName';\nimport bindActionCreators from '../utils/bindActionCreators';\nimport mergeIntoFalcorJSON from '../utils/mergeIntoFalcorJSON';\nimport invalidateFalcorJSON from '../utils/invalidateFalcorJSON';\nimport fetchDataUntilSettled from '../utils/fetchDataUntilSettled';\n\nconst contextTypes = {\n    falcor: PropTypes.object,\n    version: PropTypes.number,\n    dispatch: PropTypes.func\n};\n\nclass FalcorContainer extends React.Component {\n\n    static contextTypes = contextTypes;\n    static childContextTypes = contextTypes;\n\n    constructor(props, context) {\n        super(props, context);\n\n        const { data } = props;\n        const { fragment, Component,\n                mergeFragmentAndProps,\n                mapFragment, mapDispatch } = this.constructor;\n        const { falcor, version, dispatch } = context;\n\n        this.fragment = fragment;\n        this.Component = Component;\n        this.mapDispatch = mapDispatch;\n        this.mapFragment = mapFragment;\n        this.mergeFragmentAndProps = mergeFragmentAndProps;\n\n        this.state = { data, falcor, version, dispatch };\n        this.propsStream = new Subject();\n        this.propsAction = this.propsStream\n            .map((({ data, falcor, ...rest }) => {\n                data = invalidateFalcorJSON(mapToFalcorJSON(data, falcor));\n                return { ...rest, fragment, data, falcor: data &&\n                    data.$__path &&\n                    data.$__path.length &&\n                    falcor.deref(data) || falcor\n                };\n            }))\n            .switchMap(\n                fetchDataUntilSettled,\n                ({ data, falcor, version, fragment, ...rest }, { data: d2, error }) => ({\n                    falcor, ...rest, data: d2, error\n                })\n            );\n    }\n    getChildContext() {\n        const { falcor, dispatch } = this.state;\n        return { falcor, dispatch, version: falcor.getVersion() };\n    }\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n        const { version: thisVersion, data: thisJSON, ...restProps } = this.state;\n        const { version: nextVersion, data: nextJSON, ...restNextProps } = nextProps;\n        if (thisVersion !== nextVersion) {\n            return true;\n        } else if (!thisJSON || !nextJSON || thisJSON.$__hash !== nextJSON.$__hash) {\n            return true;\n        }\n        return !shallowEqual(restProps, restNextProps);\n    }\n    componentWillReceiveProps(nextProps, nextContext) {\n        // Receive new props from the owner\n        this.propsStream.next({ ...nextContext, ...nextProps });\n    }\n    componentWillMount() {\n        // Subscribe to child prop changes so we know when to re-render\n        this.propsSubscription = this.propsAction.subscribe((nextProps) => {\n            this.setState(nextProps);\n        });\n        this.propsStream.next({ ...this.context, ...this.props });\n    }\n    componentWillUnmount() {\n        // Clean-up subscription before un-mounting\n        this.propsSubscription.unsubscribe();\n        this.fragment = null;\n        this.Component = null;\n        this.mapDispatch = null;\n        this.mapFragment = null;\n        this.mergeFragmentAndProps = null;\n    }\n    render() {\n\n        const { Component,\n                mergeFragmentAndProps,\n                mapFragment, mapDispatch } = this;\n\n        const { data, error, falcor, version,\n                loading, dispatch, fragment, ...rest } = this.state;\n\n        const mappedFragment = mapFragment(data, { error, ...rest });\n        const mappedDispatch = mapDispatch(dispatch, mappedFragment, falcor);\n        const {\n            $__key, $__path, $__refPath, $__version,\n            $__hash__$, $__keysPath, $__keyDepth, $__toReference,\n            ...allMergedProps\n        } = mergeFragmentAndProps(mappedFragment, mappedDispatch, rest);\n\n        return (\n            <Component { ...allMergedProps }/>\n        );\n    }\n}\n\nconst defaultMapFragmentToProps = (data) => data;\nconst defaultMapDispatchToProps = (dispatch, props, falcor) => ({});\nconst defaultMergeProps = (stateProps, dispatchProps, parentProps) => ({\n    ...parentProps, ...stateProps, ...dispatchProps\n});\n\nexport default function container(\n    getFragment,\n    mapFragment = defaultMapFragmentToProps,\n    mapDispatch = defaultMapDispatchToProps,\n    mergeFragmentAndProps = defaultMergeProps) {\n\n    if (typeof mapDispatch !== 'function') {\n        if (mapDispatch && typeof mapDispatch !== 'object') {\n            mapDispatch = defaultMapDispatchToProps;\n        } else {\n            mapDispatch = function(actionCreators) {\n                return function(dispatch, mappedFragment, falcor) {\n                    return bindActionCreators(actionCreators, dispatch, falcor);\n                };\n            }(mapDispatch)\n        }\n    }\n\n    return hoistStatics((BaseComponent) => class Container extends FalcorContainer {\n        static fragment = getFragment;\n        static Component = BaseComponent;\n        static mapFragment = mapFragment;\n        static mapDispatch = mapDispatch;\n        static mergeFragmentAndProps = mergeFragmentAndProps;\n        static displayName = wrapDisplayName(BaseComponent, 'Container');\n    });\n}\n"]}