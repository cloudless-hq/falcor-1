{"version":3,"sources":["../../src/components/connect.js"],"names":["prototype","changes","_root","onChange","call","next","typeofObject","reduxOptions","pure","contextTypes","falcor","object","dispatch","func","connect","BaseComponent","scheduler","mapReduxStoreToProps","mergeReduxProps","mapPropsToDistinctChanges","componentDidUpdate","props","data","type","store","_recycleJSON","_seed","json","undefined","__proto__","innerMapPropsToDistinctChanges","prop$","switchMap","mapPropsToChanges","mapChangeToProps","distinctUntilKeyChanged","auditTime","version","getVersion"],"mappings":"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","file":"connect.js","sourcesContent":["import compose from 'recompose/compose';\nimport lifecycle from 'recompose/lifecycle';\nimport withContext from 'recompose/withContext';\nimport hoistStatics from 'recompose/hoistStatics';\nimport mapPropsStream from 'recompose/mapPropsStream';\nimport setDisplayName from 'recompose/setDisplayName';\nimport wrapDisplayName from 'recompose/wrapDisplayName';\nimport setObservableConfig from 'recompose/setObservableConfig';\nimport rxjsObservableConfig from 'recompose/rxjsObservableConfig';\n\nimport invariant from 'invariant';\nimport React, { PropTypes, Children } from 'react';\nimport { connect as connectRedux } from 'react-redux';\n\nimport { Observable } from 'rxjs/Observable';\nimport { BehaviorSubject } from 'rxjs/BehaviorSubject';\nimport { Model, FalcorJSON } from '@graphistry/falcor';\nimport { animationFrame } from 'rxjs/scheduler/animationFrame';\n// import { asap as asapScheduler } from 'rxjs/scheduler/asap';\n\nimport 'rxjs/add/operator/auditTime';\nimport 'rxjs/add/operator/switchMap';\nimport 'rxjs/add/operator/distinctUntilKeyChanged';\n\nif (!Model.prototype.changes) {\n    Model.prototype.changes = function() {\n        const { _root } = this;\n        let { changes } = _root;\n        if (!changes) {\n            changes = _root.changes = new BehaviorSubject(this);\n            const { onChange } = _root;\n            _root.onChange = () => {\n                if (onChange) {\n                    onChange.call(this);\n                }\n                changes.next(this);\n            }\n        }\n        return changes;\n    }\n}\n\nsetObservableConfig(rxjsObservableConfig);\n\nconst typeofObject = 'object';\nconst reduxOptions = { pure: false };\nconst contextTypes = {\n    falcor: PropTypes.object,\n    dispatch: PropTypes.func\n};\n\nconst connect = (BaseComponent, scheduler = animationFrame) => hoistStatics(compose(\n    connectRedux(mapReduxStoreToProps, 0, mergeReduxProps, reduxOptions),\n    setDisplayName(wrapDisplayName(BaseComponent, 'Falcor')),\n    mapPropsStream(mapPropsToDistinctChanges(scheduler)),\n    withContext(contextTypes, ({ falcor, dispatch }) => ({\n        falcor, dispatch\n    })),\n    lifecycle({\n        componentDidUpdate() {\n            this.props.dispatch({\n                data: this.props.data,\n                type: 'falcor-react-redux/update'\n            });\n        }\n    })\n))(BaseComponent);\n\nexport { connect };\nexport default connect;\n\nfunction mapReduxStoreToProps(store, { falcor }) {\n    invariant(falcor, `The top level \"connect\" container requires a root falcor model.`);\n    if (!store || typeofObject !== typeof store) {\n        store = !falcor._recycleJSON ? new FalcorJSON() :\n            falcor._seed && falcor._seed.json || undefined;\n    } else if (!(store instanceof FalcorJSON)) {\n        if (!falcor._recycleJSON) {\n            store = new FalcorJSON(store);\n        } else if (!falcor._seed || !falcor._seed.json) {\n            falcor._seed = { json: store = {\n                __proto__: new FalcorJSON(store) },\n                __proto__: FalcorJSON.prototype\n            };\n        } else {\n            store = falcor._seed.json;\n        }\n    }\n    return { data: store };\n}\n\nfunction mergeReduxProps({ data }, { dispatch }, { falcor }) {\n    return { data, falcor, dispatch };\n}\n\nfunction mapPropsToDistinctChanges(scheduler) {\n    return function innerMapPropsToDistinctChanges(prop$) {\n        return prop$.switchMap(\n            mapPropsToChanges, mapChangeToProps\n        )\n        .distinctUntilKeyChanged('version')\n        .auditTime(0, scheduler);\n    }\n}\n\nfunction mapPropsToChanges({ falcor }) {\n    return falcor.changes();\n}\n\nfunction mapChangeToProps(props, falcor) {\n    return { ...props, falcor, version: falcor.getVersion() };\n}\n"]}