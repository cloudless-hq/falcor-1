{"version":3,"sources":["../../src/components/container.js"],"names":["typeofNumber","typeofObject","typeofFunction","defaultMapFragmentToProps","data","defaultMapDispatchToProps","dispatch","props","falcor","defaultMergeProps","stateProps","dispatchProps","parentProps","container","fragmentDesc","fragment","renderErrors","renderLoading","mapFragment","mapDispatch","mapFragmentAndProps","dispatchers","bindActionCreators","Component","context","FalcorContainer","fragments","contextTypes","childContextTypes","displayName","items","hasOwnProperty","x","i","reduce","xs","actionCreators","key","actionCreator","state","tryDeref","deref","fetchEachPropUpdate","update","of","takeLast","mergeEachPropUpdate","error","version","loading","hash","$__hash","object","func","componentProps","propsStream","propsAction","switchMap","nextProps","nextState","nextContext","currProps","currState","traceShouldUpdate","currData","style","currStyle","restCurrProps","nextData","nextStyle","restNextProps","next","propsSubscription","subscribe","setState","traceWillUpdate","global","message","log","inspect","unsubscribe","undefined","mergeFragmentAndProps","mappedFragment","allMergedProps"],"mappings":"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","file":"container.js","sourcesContent":["import invariant from 'invariant';\nimport React, { PropTypes, Children } from 'react';\nimport hoistStatics from 'recompose/hoistStatics';\nimport shallowEqual from 'recompose/shallowEqual';\nimport wrapDisplayName from 'recompose/wrapDisplayName';\nimport fetchDataUntilSettled from '../utils/fetchDataUntilSettled';\n\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/observable/of';\nimport 'rxjs/add/operator/switchMap';\nimport { Subject } from 'rxjs/Subject';\nimport { Observable } from 'rxjs/Observable';\n\nconst typeofNumber = 'number';\nconst typeofObject = 'object';\nconst typeofFunction = 'function';\nconst defaultMapFragmentToProps = (data) => data;\nconst defaultMapDispatchToProps = (dispatch, props, falcor) => ({});\nconst defaultMergeProps = (stateProps, dispatchProps, parentProps) => ({\n    ...parentProps, ...stateProps, ...dispatchProps\n});\n\nexport { container };\nexport default container;\n\nfunction container(fragmentDesc, ...rest) {\n\n    invariant(fragmentDesc && (\n              typeofFunction === typeof fragmentDesc || (\n              typeofObject   === typeof fragmentDesc &&\n              typeofFunction === typeof fragmentDesc.fragment)),\n`Attempted to create a Falcor container component without a fragment.\nFalcor containers must be created with a fragment function, or an Object with a \"fragment\" function.`);\n\n    let renderErrors = false,\n        renderLoading = false,\n        fragment, mapFragment,\n        mapDispatch, mapFragmentAndProps;\n\n    if (typeofObject !== typeof fragmentDesc) {\n        fragment = fragmentDesc;\n        mapFragment = rest[0];\n        mapDispatch = rest[1];\n        mapFragmentAndProps = rest[2];\n    } else {\n        fragment = fragmentDesc.fragment;\n        mapFragment = fragmentDesc.mapFragment;\n        renderErrors = fragmentDesc.renderErrors;\n        renderLoading = fragmentDesc.renderLoading;\n        mapFragmentAndProps = fragmentDesc.mapFragmentAndProps;\n        mapDispatch = fragmentDesc.mapDispatch || fragmentDesc.dispatchers;\n    }\n\n    mapFragment = mapFragment || defaultMapFragmentToProps;\n    mapDispatch = mapDispatch || defaultMapDispatchToProps;\n    mapFragmentAndProps = mapFragmentAndProps || defaultMergeProps;\n\n    if (typeofFunction !== typeof mapDispatch) {\n        if (mapDispatch && typeofObject !== typeof mapDispatch) {\n            mapDispatch = defaultMapDispatchToProps;\n        } else {\n            mapDispatch = bindActionCreators(mapDispatch);\n        }\n    }\n\n    return hoistStatics((Component) => class Container extends FalcorContainer {\n        static fragment = fragment;\n        static fragments = fragments;\n        static contextTypes = contextTypes;\n        static childContextTypes = contextTypes;\n        static displayName = wrapDisplayName(Component, 'Container');\n        constructor(props, context) {\n            super(props, context);\n            this.fragment = fragment;\n            this.Component = Component;\n            this.mapFragment = mapFragment;\n            this.renderErrors = renderErrors;\n            this.renderLoading = renderLoading;\n            this.dispatchers = mapDispatch(this);\n            this.mapFragmentAndProps = mapFragmentAndProps;\n        }\n    });\n}\n\nconst fragments = function(items = []) {\n    if (!items ||\n        typeofObject !== typeof items ||\n        !items.hasOwnProperty('length')) {\n        return `{ length }`;\n    }\n    return `{ length ${Array\n        .from(items, (x, i) => x)\n        .reduce((xs, x, i) =>`${xs}, ${\n            i}: ${this.fragment(x)}`, '')\n    }}`;\n}\n\nfunction bindActionCreators(actionCreators) {\n    return function mapDispatch(container) {\n        return Object.keys(actionCreators).reduce((dispatchers, key) => {\n            const actionCreator = actionCreators[key];\n            dispatchers[key] = (...args) => {\n                const { falcor, dispatch } = container.state;\n                if (falcor) {\n                    return dispatch({ falcor, ...actionCreator(...args) });\n                }\n            };\n            return dispatchers;\n        }, {});\n    }\n}\n\nfunction tryDeref({ data, falcor }) {\n    return !data || !falcor ?\n        falcor : falcor.deref(data);\n}\n\nfunction fetchEachPropUpdate(update) {\n    if (!(update.falcor = tryDeref(update))) {\n        return Observable.of(update);\n    } else if (update.renderLoading === true) {\n        return fetchDataUntilSettled(update);\n    }\n    return fetchDataUntilSettled(update).takeLast(1);\n}\n\nfunction mergeEachPropUpdate(\n    { props, falcor, dispatch },\n    { data, error, version, loading }\n) {\n    const hash = data && data.$__hash;\n    loading = loading || !(hash !== '__loading__');\n    return {\n        hash, props, falcor, dispatch,\n        data, error, loading, version\n    };\n}\n\nconst contextTypes = {\n    falcor: PropTypes.object,\n    dispatch: PropTypes.func,\n};\n\nclass FalcorContainer extends React.Component {\n    constructor(componentProps, context) {\n\n        super(componentProps, context);\n\n        const { falcor } = context;\n        const { data, ...props } = componentProps;\n\n        this.propsStream = new Subject();\n        this.propsAction = this.propsStream.switchMap(\n            fetchEachPropUpdate, mergeEachPropUpdate\n        );\n\n        this.state = {\n            data, props,\n            dispatch: context.dispatch,\n            falcor: tryDeref({ data, falcor })\n        };\n    }\n    getChildContext() {\n        const { falcor, dispatch } = this.state;\n        return { falcor, dispatch };\n    }\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n\n        const { renderLoading,\n                props: currProps = {},\n                state: currState = {} } = this;\n\n        if (renderLoading === true) {\n            if (currState.loading !== nextState.loading) {\n                this.traceShouldUpdate('loading', currState.loading, '->', nextState.loading);\n                return true;\n            } else if (!(nextState.hash !== '__loading__')) {\n                this.traceShouldUpdate('loading global && nextState.hash === \"__loading__\"', nextProps);\n                return true;\n            }\n        }\n\n        if (currState.version !== nextState.version) {\n            this.traceShouldUpdate('version', currState.version, '->', nextState.version);\n            return true;\n        } else if (currState.error !== nextState.error) {\n            this.traceShouldUpdate('error', currState.error, '->', nextState.error);\n            return true;\n        } else if (currState.hash !== nextState.hash) {\n            this.traceShouldUpdate('hash', currState.hash, '->', nextState.hash);\n            return true;\n        }\n\n        const { data: currData, style: currStyle = {}, ...restCurrProps } = currProps;\n        const { data: nextData, style: nextStyle = currStyle, ...restNextProps } = nextProps;\n\n        if (!shallowEqual(currData, nextData)) {\n            this.traceShouldUpdate('data', currData, '->', nextData);\n            return true;\n        } else if (!shallowEqual(currStyle, nextStyle)) {\n            this.traceShouldUpdate('style', currStyle, '->', nextStyle);\n            return true;\n        } else if (!shallowEqual(restCurrProps, restNextProps)) {\n            this.traceShouldUpdate('props', restCurrProps, '->', restNextProps);\n            return true;\n        }\n\n        this.traceShouldUpdate(false, currProps, '->', nextProps);\n\n        return false;\n    }\n    componentWillReceiveProps(nextProps, nextContext) {\n        // Receive new props from the owner\n        const { data, ...props } = nextProps;\n        this.propsStream.next({\n            data, props,\n            fragment: this.fragment,\n            falcor: nextContext.falcor,\n            version: this.state.version,\n            dispatch: nextContext.dispatch,\n            renderLoading: this.renderLoading\n        });\n    }\n    componentWillMount() {\n        const { data, ...props } = this.props;\n        // Subscribe to child prop changes so we know when to re-render\n        this.propsSubscription = this.propsAction.subscribe((nextState) => {\n            this.setState(nextState);\n        });\n        this.propsStream.next({\n            data, props,\n            fragment: this.fragment,\n            falcor: this.context.falcor,\n            version: this.state.version,\n            dispatch: this.context.dispatch,\n            renderLoading: this.renderLoading\n        });\n    }\n    componentWillUpdate(nextProps, nextState) {\n        this.traceWillUpdate(nextState.loading || false, nextProps, nextState);\n    }\n    traceShouldUpdate(...message) {\n        if (!global['__trace_container_diffs__']) {\n            return;\n        }\n        console.log(this.inspect(), ...message);\n    }\n    traceWillUpdate(...message) {\n        if (!global['__trace_container_updates__']) {\n            return;\n        }\n        console.log(this.inspect(), ...message);\n    }\n    inspect(...message) {\n        const { state = {} } = this;\n        const { falcor } = state;\n        return falcor && falcor.inspect() || `{ v: -1, p: [] }`;\n    }\n    componentWillUnmount() {\n        // Clean-up subscription before un-mounting\n        this.propsSubscription.unsubscribe();\n        this.propsSubscription = undefined;\n        this.fragment = null;\n        this.Component = null;\n        this.dispatchers = null;\n        this.mapDispatch = null;\n        this.mapFragment = null;\n        this.renderLoading = null;\n        this.mergeFragmentAndProps = null;\n    }\n    render() {\n\n        const { renderErrors, renderLoading,\n                mapFragment, mapFragmentAndProps,\n                Component, dispatchers, state, context } = this;\n\n        if (!Component) {\n            return null;\n        }\n\n        const { data, props, error } = state;\n        const mappedFragment = mapFragment(data || [], props);\n        const allMergedProps = mapFragmentAndProps(mappedFragment, dispatchers, props);\n\n        if (error && renderErrors === true) {\n            allMergedProps.error = error;\n        }\n\n        if (renderLoading === true) {\n            allMergedProps.loading = state.loading || false;\n        }\n\n        return <Component { ...allMergedProps }/>;\n    }\n}\n"]}