{"version":3,"sources":["../../src/utils/fetchDataUntilSettled.js"],"names":["fetchDataUntilSettled","memoizedQuerySyntax","data","props","falcor","fragment","renderLoading","memo","query","loading","version","getVersion","mapNext","handleNext","catchError","handleError","of","expand","_fetchDataUntilSettled","empty","ast","error","handleParseError","from","get","progressively","map","catch","json","console"],"mappings":"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","file":"fetchDataUntilSettled.js","sourcesContent":["import warning from 'warning';\nimport { errorMessage } from 'pegjs-util';\nimport memoizeQueryies from './memoizeQueryies';\nimport { Observable } from 'rxjs/Observable';\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/operator/catch';\nimport 'rxjs/add/operator/expand';\nimport 'rxjs/add/observable/of';\nimport 'rxjs/add/observable/from';\nimport 'rxjs/add/observable/empty';\n\nconst memoizedQuerySyntax = memoizeQueryies(100);\n\nexport default function fetchDataUntilSettled({\n    data, props, falcor, fragment, renderLoading\n}) {\n\n    const memo = {\n        query: null, loading: true,\n        version: falcor.getVersion(),\n        data, props, falcor, fragment,\n    };\n    memo.mapNext = handleNext(memo, falcor);\n    memo.catchError = handleError(memo, falcor);\n\n    return Observable.of(memo).expand(_fetchDataUntilSettled);\n}\n\nfunction _fetchDataUntilSettled(memo) {\n    if (memo.loading === false) {\n        return Observable.empty();\n    }\n    let { query, falcor, version, fragment } = memo;\n    if ((query !== (memo.query = fragment(memo.data, memo.props))) ||\n        (version !== (memo.version = falcor.getVersion()))) {\n        let { ast, error } = memoizedQuerySyntax(memo.query);\n        if (error) {\n            return handleParseError(memo, error);\n        }\n        return Observable\n            .from(!memo.renderLoading ?\n                   falcor.get(ast) :\n                   falcor.get(ast).progressively())\n            .map(memo.mapNext)\n            .catch(memo.catchError);\n    }\n    return Observable.of({\n        loading: false,\n        data: memo.data,\n        version: memo.version\n    });\n}\n\nfunction handleNext(memo, falcor) {\n    return function mapNext({ json: data }) {\n        return Object.assign(memo, {\n            data, loading: true,\n            version: falcor.getVersion()\n        });\n    }\n}\n\nfunction handleError(memo, falcor) {\n    return function catchError(error) {\n        return Observable.of({\n            error,\n            data: memo.data,\n            loading: false,\n            version: falcor.getVersion()\n        });\n    };\n}\n\nfunction handleParseError(memo, error) {\n    if (typeof console !== 'undefined' && typeof console.error === 'function') {\n        console.error(errorMessage(error));\n        console.error(`Error parsing query: ${memo.query}`);\n    }\n    return Observable.of({\n        error,\n        loading: false,\n        data: memo.data,\n        version: memo.version,\n    });\n}\n"]}