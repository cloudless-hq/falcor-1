{"version":3,"sources":["../../src/utils/fetchDataUntilSettled.js"],"names":["fetchDataUntilSettled","memoizedQuerySyntax","data","props","falcor","version","fragment","disposeDelay","disposeScheduler","memo","query","loading","mapNext","handleNext","catchError","handleError","of","expand","_fetchDataUntilSettled","empty","nextQuery","e","ast","error","console","getVersion","from","get","progressively","map","catch","let","delayDispose","bind","json","scheduler","delay","source","lift","DelayDisposeOperator","sink","_subscribe","DelayDisposeSubscriber","unsubscriptionDisposable","closed","isStopped","schedule","unsubscribe","err","destination","complete"],"mappings":"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","file":"fetchDataUntilSettled.js","sourcesContent":["import { errorMessage } from 'pegjs-util';\nimport memoizeQueryies from './memoizeQueryies';\nimport { Observable } from 'rxjs/Observable';\nimport { Subscriber } from 'rxjs/Subscriber';\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/operator/catch';\nimport 'rxjs/add/operator/expand';\nimport 'rxjs/add/observable/of';\nimport 'rxjs/add/observable/from';\nimport 'rxjs/add/observable/empty';\n\nconst memoizedQuerySyntax = memoizeQueryies(100);\n\nexport default function fetchDataUntilSettled({\n    data, props, falcor, version, fragment,\n    disposeDelay = 0, disposeScheduler\n}) {\n\n    const memo = {\n        query: null, loading: true,\n        data, props, falcor, version, fragment,\n        disposeDelay, disposeScheduler\n    };\n    memo.mapNext = handleNext(memo, falcor);\n    memo.catchError = handleError(memo, falcor);\n\n    return Observable.of(memo).expand(_fetchDataUntilSettled);\n}\n\nfunction _fetchDataUntilSettled(memo) {\n    if (memo.loading === false) {\n        return Observable.empty();\n    }\n    let nextQuery;\n    const { query, falcor, fragment } = memo;\n    try {\n        nextQuery = fragment(memo.data || {}, memo.props || {});\n    } catch (e) {\n        return memo.catchError(e);\n    }\n    if (query !== (memo.query = nextQuery)) {\n        const { ast, error } = memoizedQuerySyntax(memo.query);\n        if (error) {\n            if (typeof console !== 'undefined' && typeof console.error === 'function') {\n                console.error(errorMessage(error));\n                console.error(`Error parsing query: ${memo.query}`);\n            }\n            memo.error = error;\n            memo.version = falcor.getVersion();\n        } else {\n            return Observable\n                .from(falcor.get(ast).progressively())\n                .map(memo.mapNext).catch(memo.catchError)\n                .let(delayDispose.bind(null, memo.disposeScheduler, memo.disposeDelay));\n        }\n    }\n    memo.loading = false;\n    return Observable.of(memo);\n}\n\nfunction handleNext(memo, falcor) {\n    return function mapNext({ json: data }) {\n        memo.data = data;\n        memo.loading = true;\n        memo.version = falcor.getVersion();\n        return memo;\n    }\n}\n\nfunction handleError(memo, falcor) {\n    return function catchError(error) {\n        memo.error = error;\n        memo.loading = false;\n        memo.version = falcor.getVersion();\n        return Observable.of(memo);\n    };\n}\n\nfunction delayDispose(scheduler, delay, source) {\n    return !scheduler ? source : source.lift(new DelayDisposeOperator(scheduler, delay));\n}\n\nclass DelayDisposeOperator {\n    constructor(scheduler, delay) {\n        this.delay = delay;\n        this.scheduler = scheduler;\n    }\n    call(sink, source) {\n        return source._subscribe(new DelayDisposeSubscriber(sink, this.scheduler, this.delay));\n    }\n}\n\nclass DelayDisposeSubscriber extends Subscriber {\n    constructor(sink, scheduler, delay) {\n        super(sink);\n        this.delay = delay;\n        this.scheduler = scheduler;\n        this.unsubscriptionDisposable = null;\n    }\n    superUnsubscribe() { return super.unsubscribe(); }\n    unsubscribe() {\n        if (!this.closed && !this.isStopped && !this.unsubscriptionDisposable) {\n            this.isStopped = true;\n            this.unsubscriptionDisposable = this.scheduler.schedule(() => {\n                super.unsubscribe();\n            }, this.delay);\n        }\n    }\n    _unsubscribe() {\n        const { unsubscriptionDisposable } = this;\n        if (unsubscriptionDisposable) {\n            this.unsubscriptionDisposable = null;\n            unsubscriptionDisposable.unsubscribe();\n        }\n    }\n    _error(err) {\n        this.destination.error(err);\n        super.unsubscribe();\n    }\n    _complete() {\n        this.destination.complete();\n        super.unsubscribe();\n    }\n}\n"]}