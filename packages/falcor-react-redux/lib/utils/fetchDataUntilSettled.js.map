{"version":3,"sources":["../../src/utils/fetchDataUntilSettled.js"],"names":["fetchDataUntilSettled","memoizedQuerySyntax","data","query","props","falcor","version","fragment","disposeDelay","disposeScheduler","memo","loading","mapNext","handleNext","catchError","handleError","_fetchDataInitial","expand","_fetchDataUntilSettled","ast","error","from","get","progressively","map","catch","let","delayDispose","bind","of","empty","nextQuery","e","console","getVersion","json","scheduler","delay","source","lift","DelayDisposeOperator","sink","_subscribe","DelayDisposeSubscriber","unsubscriptionDisposable","closed","isStopped","schedule","unsubscribe","err","destination","complete"],"mappings":"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","file":"fetchDataUntilSettled.js","sourcesContent":["import { errorMessage } from 'pegjs-util';\nimport memoizeQueryies from './memoizeQueryies';\nimport { Observable } from 'rxjs/Observable';\nimport { Subscriber } from 'rxjs/Subscriber';\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/operator/catch';\nimport 'rxjs/add/operator/expand';\nimport 'rxjs/add/observable/of';\nimport 'rxjs/add/observable/from';\nimport 'rxjs/add/observable/empty';\n\nconst memoizedQuerySyntax = memoizeQueryies(100);\n\nexport default function fetchDataUntilSettled({\n    data, query, props, falcor, version, fragment,\n    disposeDelay = 0, disposeScheduler\n}) {\n\n    const memo = {\n        query, loading: true,\n        data, props, falcor, version, fragment,\n        disposeDelay, disposeScheduler\n    };\n    memo.mapNext = handleNext(memo, falcor);\n    memo.catchError = handleError(memo, falcor);\n\n    return _fetchDataInitial(memo).expand(_fetchDataUntilSettled);\n}\n\nfunction _fetchDataInitial(memo) {\n    if (memo.query) {\n        const { ast, error } = memoizedQuerySyntax(memo.query);\n        if (!error) {\n            return Observable\n                .from(memo.falcor.get(ast).progressively())\n                .map(memo.mapNext).catch(memo.catchError)\n                .let(delayDispose.bind(null, memo.disposeScheduler, memo.disposeDelay));\n        }\n    }\n    return Observable.of(memo);\n}\n\nfunction _fetchDataUntilSettled(memo) {\n    if (memo.loading === false) {\n        return Observable.empty();\n    }\n    let nextQuery;\n    const { query, falcor, fragment } = memo;\n    try {\n        nextQuery = fragment(memo.data || {}, memo.props || {});\n    } catch (e) {\n        return memo.catchError(e);\n    }\n    if (query !== (memo.query = nextQuery)) {\n        const { ast, error } = memoizedQuerySyntax(nextQuery);\n        if (error) {\n            if (typeof console !== 'undefined' && typeof console.error === 'function') {\n                console.error(errorMessage(error));\n                console.error(`Error parsing query: ${nextQuery}`);\n            }\n            memo.error = error;\n            memo.version = falcor.getVersion();\n        } else {\n            return Observable\n                .from(falcor.get(ast).progressively())\n                .map(memo.mapNext).catch(memo.catchError)\n                .let(delayDispose.bind(null, memo.disposeScheduler, memo.disposeDelay));\n        }\n    }\n    memo.loading = false;\n    return Observable.of(memo);\n}\n\nfunction handleNext(memo, falcor) {\n    return function mapNext({ json: data }) {\n        memo.data = data;\n        memo.loading = true;\n        memo.version = falcor.getVersion();\n        return memo;\n    }\n}\n\nfunction handleError(memo, falcor) {\n    return function catchError(error) {\n        memo.error = error;\n        memo.loading = false;\n        memo.version = falcor.getVersion();\n        return Observable.of(memo);\n    };\n}\n\nfunction delayDispose(scheduler, delay, source) {\n    return !scheduler ? source : source.lift(new DelayDisposeOperator(scheduler, delay));\n}\n\nclass DelayDisposeOperator {\n    constructor(scheduler, delay) {\n        this.delay = delay;\n        this.scheduler = scheduler;\n    }\n    call(sink, source) {\n        return source._subscribe(new DelayDisposeSubscriber(sink, this.scheduler, this.delay));\n    }\n}\n\nclass DelayDisposeSubscriber extends Subscriber {\n    constructor(sink, scheduler, delay) {\n        super(sink);\n        this.delay = delay;\n        this.scheduler = scheduler;\n        this.unsubscriptionDisposable = null;\n    }\n    superUnsubscribe() { return super.unsubscribe(); }\n    unsubscribe() {\n        if (!this.closed && !this.isStopped && !this.unsubscriptionDisposable) {\n            this.isStopped = true;\n            this.unsubscriptionDisposable = this.scheduler.schedule(() => {\n                super.unsubscribe();\n            }, this.delay);\n        }\n    }\n    _unsubscribe() {\n        const { unsubscriptionDisposable } = this;\n        if (unsubscriptionDisposable) {\n            this.unsubscriptionDisposable = null;\n            unsubscriptionDisposable.unsubscribe();\n        }\n    }\n    _error(err) {\n        this.destination.error(err);\n        super.unsubscribe();\n    }\n    _complete() {\n        this.destination.complete();\n        super.unsubscribe();\n    }\n}\n"]}