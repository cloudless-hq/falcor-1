{"version":3,"sources":["../../src/utils/fetchDataUntilSettled.js"],"names":["fetchDataUntilSettled","memoizedQuerySyntax","data","props","falcor","version","fragment","memo","query","loading","mapNext","handleNext","catchError","handleError","of","expand","_fetchDataUntilSettled","empty","getVersion","ast","error","console","from","get","map","catch","json"],"mappings":"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","file":"fetchDataUntilSettled.js","sourcesContent":["import warning from 'warning';\nimport { errorMessage } from 'pegjs-util';\nimport memoizeQueryies from './memoizeQueryies';\nimport { Observable } from 'rxjs/Observable';\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/operator/catch';\nimport 'rxjs/add/operator/expand';\nimport 'rxjs/add/observable/of';\nimport 'rxjs/add/observable/from';\nimport 'rxjs/add/observable/empty';\n\nconst memoizedQuerySyntax = memoizeQueryies(100);\n\nexport default function fetchDataUntilSettled({\n    data, props, falcor, version, fragment\n}) {\n\n    const memo = {\n        query: null, loading: true,\n        data, props, falcor, version, fragment,\n    };\n    memo.mapNext = handleNext(memo, falcor);\n    memo.catchError = handleError(memo, falcor);\n\n    return Observable.of(memo).expand(_fetchDataUntilSettled);\n}\n\nfunction _fetchDataUntilSettled(memo) {\n    if (memo.loading === false) {\n        return Observable.empty();\n    }\n    const { query, version, falcor, fragment } = memo;\n    if ((query !== (memo.query = fragment(memo.data || {}, memo.props))) ||\n        (version !== (memo.version = falcor.getVersion()))) {\n        const { ast, error } = memoizedQuerySyntax(memo.query);\n        if (error) {\n            if (typeof console !== 'undefined' && typeof console.error === 'function') {\n                console.error(errorMessage(error));\n                console.error(`Error parsing query: ${memo.query}`);\n            }\n            memo.error = error;\n            memo.version = falcor.getVersion();\n        } else {\n            return Observable\n                .from(falcor.get(ast))\n                .map(memo.mapNext).catch(memo.catchError);\n        }\n    }\n    memo.loading = false;\n    return Observable.of(memo);\n}\n\nfunction handleNext(memo, falcor) {\n    return function mapNext({ json: data }) {\n        memo.data = data;\n        memo.loading = true;\n        memo.version = falcor.getVersion();\n        return memo;\n    }\n}\n\nfunction handleError(memo, falcor) {\n    return function catchError(error) {\n        memo.error = error;\n        memo.loading = false;\n        memo.version = falcor.getVersion();\n        return Observable.of(memo);\n    };\n}\n"]}