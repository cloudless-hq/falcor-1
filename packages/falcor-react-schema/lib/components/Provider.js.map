{"version":3,"sources":["../../src/components/Provider.js"],"names":["Model","prototype","changes","_root","BehaviorSubject","forEach","name","handler","call","next","Provider","props","context","state","falcorData","undefined","falcorModel","renderFalcorErrors","renderFalcorLoading","propsSubscription","mapPropsToDistinctChanges","propsStream","Subject","subscribe","nextProps","unsubscribe","Children","only","children","React","Component","displayName","propTypes","PropTypes","bool","element","isRequired","object","childContextTypes","provider","props$","setStateAsync","Observable","bindCallback","callback","setState","switchMap","mapPropsToChanges","mapChangeToProps","distinctUntilChanged","getModelVersion","map","pending","multicast","ReplaySubject","updates","filter","exhaustMap","update","take","repeat","model","getVersion"],"mappings":"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","file":"Provider.js","sourcesContent":["import invariant from 'invariant';\nimport PropTypes from 'prop-types';\nimport React, { Children } from 'react';\nimport { Model } from '@graphistry/falcor';\n\nimport { Subject } from 'rxjs/Subject';\nimport { Observable } from 'rxjs/Observable';\nimport { ReplaySubject } from 'rxjs/ReplaySubject';\nimport { BehaviorSubject } from 'rxjs/BehaviorSubject';\n\nimport 'rxjs/add/observable/bindCallback';\nimport 'rxjs/add/operator/let';\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/operator/take';\nimport 'rxjs/add/operator/filter';\nimport 'rxjs/add/operator/repeat';\nimport 'rxjs/add/operator/multicast';\nimport 'rxjs/add/operator/switchMap';\nimport 'rxjs/add/operator/exhaustMap';\nimport 'rxjs/add/operator/distinctUntilChanged';\n\nif (!Model.prototype.changes) {\n    Model.prototype.changes = function() {\n        const { _root } = this;\n        let { changes } = _root;\n        if (!changes) {\n            changes = _root.changes = new BehaviorSubject(this);\n            ['onChange', 'onChangesCompleted'].forEach((name) => {\n                const handler = _root[name];\n                _root[name] = function() {\n                    if (handler) {\n                        handler.call(this);\n                    }\n                    changes.next(this);\n                }\n            });\n        }\n        return changes;\n    }\n}\n\nexport default class Provider extends React.Component {\n    static displayName = 'FalcorProvider';\n    static propTypes = {\n        renderFalcorErrors: PropTypes.bool,\n        renderFalcorLoading: PropTypes.bool,\n        children: PropTypes.element.isRequired,\n        falcorModel: PropTypes.object.isRequired,\n    };\n    static childContextTypes = {\n        falcorData: PropTypes.object,\n        falcorModel: PropTypes.object,\n        renderFalcorErrors: PropTypes.bool,\n        renderFalcorLoading: PropTypes.bool\n    };\n    constructor(props, context) {\n\n        super(props, context);\n\n        this.state = {\n            falcorData: undefined,\n            falcorModel: props.falcorModel,\n            renderFalcorErrors: props.renderFalcorErrors || false,\n            renderFalcorLoading: props.renderFalcorLoading || false,\n        };\n    }\n    getChildContext() {\n        const  { falcorData, falcorModel, renderFalcorErrors, renderFalcorLoading } = this.state;\n        return { falcorData, falcorModel, renderFalcorErrors, renderFalcorLoading };\n    }\n    componentWillMount() {\n        // Subscribe to child prop changes so we know when to re-render\n        this.propsSubscription = mapPropsToDistinctChanges(\n            this, this.propsStream = new Subject()\n        ).subscribe(() => {});\n        this.propsStream.next(this.props);\n    }\n    componentWillReceiveProps(nextProps) {\n        this.propsStream.next(nextProps);\n    }\n    componentWillUnmount() {\n        // Clean-up subscription before un-mounting\n        this.propsSubscription.unsubscribe();\n        this.propsSubscription = undefined;\n        this.propsStream = undefined;\n    }\n    render() {\n        return Children.only(this.props.children);\n    }\n}\n\nfunction mapPropsToDistinctChanges(provider, props$) {\n\n    const setStateAsync = Observable.bindCallback(\n        ({ falcorModel, renderFalcorErrors = false, renderFalcorLoading = false }, callback) => {\n            return provider.setState({ falcorModel, renderFalcorErrors, renderFalcorLoading }, callback);\n        }\n    );\n\n    return props$\n        .switchMap(mapPropsToChanges, mapChangeToProps)\n        .distinctUntilChanged(null, getModelVersion)\n        .map((props) => ({ props, pending: true }))\n        .multicast(() => new ReplaySubject(1), (updates) => updates\n            .filter(({ pending }) => pending)\n            .exhaustMap(\n                (update) => setStateAsync(update.props),\n                (update) => { update.pending = false; }\n            ).take(1).repeat()\n        );\n}\n\nfunction mapPropsToChanges(props) {\n    const model = props['falcorModel'];\n    invariant(model, `The Falcor Provider requires a root falcor Model.`);\n    return model.changes();\n}\n\nfunction mapChangeToProps(props, model) {\n    return { ...props, 'falcorModel': model };\n}\n\nfunction getModelVersion(props) {\n    return props['falcorModel'].getVersion();\n}\n"]}