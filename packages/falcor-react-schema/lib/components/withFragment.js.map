{"version":3,"sources":["../../src/components/withFragment.js"],"names":["withFragment","contextTypes","object","bool","fragmentDesc","fragment","mergeProps","defaultMergeProps","mapFragment","defaultMapFragment","Component","Container","FragmentContainer","config","displayName","props","context","constructor","state","hash","version","propsStream","propsAction","switchMap","fetchEachPropUpdate","mergeEachPropUpdate","data","model","shouldRenderLoading","propsSubscription","subscribe","nextState","setState","checkCacheAndUpdate","nextProps","nextContext","unsubscribe","undefined","hasOwnProperty","renderLoading","next","loading","currProps","currState","error","currData","nextData","style","currStyle","restCurrProps","nextStyle","restNextProps","mappedFragment","mergedProps","fragments","load","childContextTypes","items","x","i","reduce","xs","tryDeref","deref","update","of","takeLast","$__hash","fragmentProps","componentProps"],"mappings":"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","file":"withFragment.js","sourcesContent":["import invariant from 'invariant';\nimport React, { PropTypes, Children } from 'react';\nimport hoistStatics from 'recompose/hoistStatics';\nimport shallowEqual from 'recompose/shallowEqual';\nimport wrapDisplayName from 'recompose/wrapDisplayName';\nimport fetchDataUntilSettled from '../fetchDataUntilSettled';\n\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/observable/of';\nimport 'rxjs/add/operator/switchMap';\nimport { Subject } from 'rxjs/Subject';\nimport { Observable } from 'rxjs/Observable';\n\nconst contextTypes = {\n    'falcor-data': PropTypes.object,\n    'falcor-model': PropTypes.object,\n    'falcor-render-loading': PropTypes.bool\n};\n\nexport default function withFragment(fragmentDesc, ...rest) {\n\n    invariant(fragmentDesc && (\n              'function' === typeof fragmentDesc || (\n              'object'   === typeof fragmentDesc &&\n              'function' === typeof fragmentDesc.fragment)),\n`Attempted to create a Fragment container component without a fragment definition.\nFragment containers must be created with a fragment function, or an Object with a \"fragment\" function.`);\n\n    if ('object' !== typeof fragmentDesc) {\n        fragmentDesc = {\n            fragment: fragmentDesc,\n            mergeProps: rest[1] || defaultMergeProps,\n            mapFragment: rest[0] || defaultMapFragment\n        };\n    } else {\n        if (!fragmentDesc.mergeProps) {\n            fragmentDesc.mergeProps = defaultMergeProps;\n        }\n        if (!fragmentDesc.mapFragment) {\n            fragmentDesc.mapFragment = defaultMapFragment;\n        }\n    }\n\n    return hoistStatics((Component) => {\n        class Container extends FragmentContainer {\n            static config = fragmentDesc;\n            static Component = Component;\n            static fragment = fragmentDesc.fragment;\n            static displayName = wrapDisplayName(Component, 'Fragment');\n        }\n        return Container;\n    });\n}\n\nclass FragmentContainer extends React.Component {\n\n    static fragments = fragments;\n    static load = fetchEachPropUpdate;\n    static contextTypes = contextTypes;\n    static childContextTypes = contextTypes;\n\n    constructor(props, context) {\n\n        super(props, context);\n\n        const { config, fragment, Component } = this.constructor;\n\n        this.config = config;\n        this.fragment = fragment;\n        this.Component = Component;\n        this.state = { hash: '', version: 0 };\n        this.propsStream = new Subject();\n        this.propsAction = this.propsStream.switchMap(\n            fetchEachPropUpdate, mergeEachPropUpdate\n        );\n    }\n    getChildContext() {\n        const { data, model } = this.state;\n        return {\n            'falcor-data': data, 'falcor-model': model,\n            'falcor-render-loading': this.shouldRenderLoading()\n        };\n    }\n    componentWillMount() {\n        // Subscribe to child prop changes so we know when to re-render\n        this.propsSubscription = this.propsAction.subscribe((nextState) => {\n            this.setState(nextState);\n        });\n        this.checkCacheAndUpdate(this.props, this.context);\n    }\n    componentWillReceiveProps(nextProps, nextContext) {\n        this.checkCacheAndUpdate(nextProps, nextContext);\n    }\n    componentWillUnmount() {\n        // Clean-up subscription before un-mounting\n        this.propsSubscription.unsubscribe();\n        this.propsSubscription = undefined;\n        this.config = null;\n        this.fragment = null;\n        this.Component = null;\n    }\n    shouldRenderLoading(props = this.props, context = this.context) {\n        if (props.hasOwnProperty('renderLoading')) {\n            return props.renderLoading;\n        } else if (this.config.hasOwnProperty('renderLoading')) {\n            return this.config.renderLoading;\n        }\n        return context['falcor-render-loading'] || false;\n    }\n    checkCacheAndUpdate(props, context) {\n\n        const { fragment } = this;\n\n        // if (props.hasOwnProperty('falcor-data') || props.hasOwnProperty('falcor-model')) {\n        this.propsStream.next({\n            props, fragment, loading: false,\n            data: props['falcor-data'] || context['falcor-data'],\n            model: props['falcor-model'] || context['falcor-model'],\n            renderLoading: this.shouldRenderLoading(props, context),\n        });\n        // }\n    }\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n\n        const { props: currProps = {}, state: currState = {} } = this;\n\n        if (currState.loading !== nextState.loading && (\n            this.shouldRenderLoading(this.props, this.context) ||\n            this.shouldRenderLoading(nextProps, nextContext))) {\n            return true;\n        } else if (currState.version !== nextState.version) {\n            return true;\n        } else if (currState.error !== nextState.error) {\n            return true;\n        } else if (currState.hash !== nextState.hash) {\n            return true;\n        }\n\n        const currData = currProps['falcor-data'];\n        const nextData = nextProps['falcor-data'];\n        const { style: currStyle = {}, ...restCurrProps } = currProps;\n        const { style: nextStyle = currStyle, ...restNextProps } = nextProps;\n\n        if (!shallowEqual(currData, nextData)) {\n            return true;\n        } else if (!shallowEqual(currStyle, nextStyle)) {\n            return true;\n        } else if (!shallowEqual(restCurrProps, restNextProps)) {\n            return true;\n        }\n\n        return false;\n    }\n    render() {\n\n        const { props, state, config, Component } = this;\n\n        if (!Component) {\n            return null;\n        }\n\n        const { data, error, loading } = state;\n        const { mergeProps, mapFragment } = config;\n        const mappedFragment = data ? mapFragment(data, props) : {};\n        const mergedProps = mergeProps(mappedFragment, props);\n\n        if (error) {\n            mergedProps.error = error;\n        }\n\n        if (loading && this.shouldRenderLoading(props) === true) {\n            mergedProps.loading = loading;\n        }\n\n        return <Component { ...mergedProps }/>;\n    }\n}\n\nfunction fragments(items = []) {\n    if (!items ||\n        'object' !== typeof items ||\n        !items.hasOwnProperty('length')) {\n        return `{ length }`;\n    }\n    return `{ length ${Array\n        .from(items, (x, i) => x)\n        .reduce((xs, x, i) =>`${xs}, ${\n            i}: ${this.fragment(x)}`, '')\n    }}`;\n}\n\nfunction tryDeref({ data, model }) {\n    return !data || !model ?\n        model : model.deref(data);\n}\n\nfunction fetchEachPropUpdate(update) {\n    if (!(update.model = tryDeref(update))) {\n        return Observable.of(update);\n    } else if (update.renderLoading === true) {\n        return fetchDataUntilSettled(update);\n    }\n    return fetchDataUntilSettled(update).takeLast(1);\n}\n\nfunction mergeEachPropUpdate(\n    { props, model },\n    { data, error, version, loading }\n) {\n    return {\n        data, error, props,\n        model, loading, version,\n        hash: data && data.$__hash\n    };\n}\n\nfunction defaultMapFragment(fragmentProps) {\n    return fragmentProps;\n}\n\nfunction defaultMergeProps(fragmentProps, componentProps) {\n    return { ...componentProps, ...fragmentProps };\n}\n"]}